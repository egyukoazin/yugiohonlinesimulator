<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LOB Pack Opener</title>
<style>
  :root{
    --accent:#1e6fff;
    --panel:#ffffff;
    --muted:#666;
    --shadow: 0 6px 18px rgba(20,20,40,0.08);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{
    margin:0;
    background: linear-gradient(180deg,#f7fbff 0%, #ffffff 100%);
    color:#111;
    min-height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:36px;
    box-sizing:border-box;
  }
  .wrap{
    width:100%;
    max-width:1100px;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:28px;
  }

  /* Left: pack + controls */
  .left{
    background:var(--panel);
    border-radius:12px;
    padding:18px;
    box-shadow:var(--shadow);
  }
  .pack-stage{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }
  .pack{
    width:300px;
    height:420px;
    background:#eee;
    border-radius:8px;
    box-shadow:0 14px 40px rgba(0,0,0,0.12);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
    cursor:pointer;
    transition:transform .28s ease;
  }
  .pack img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .pack:active{ transform: translateY(2px) scale(.995); }
  .open-hint{
    background:rgba(255,255,255,0.9);
    padding:8px 12px;
    border-radius:999px;
    font-weight:600;
    color:var(--accent);
    box-shadow:0 6px 20px rgba(30,110,255,0.08);
  }

  .controls{
    margin-top:12px;
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
  }
  .btn{
    background:var(--accent);
    color:white;
    padding:10px 14px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 8px 20px rgba(30,110,255,0.12);
  }
  .btn.secondary{
    background:#f3f7ff;
    color:var(--accent);
    box-shadow:none;
  }

  /* Right: reveal area + collection */
  .right{
    background:var(--panel);
    border-radius:12px;
    padding:18px;
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .reveal-area{
    min-height:420px;
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-content:flex-start;
    padding:8px;
    justify-content:center;
  }

  .card-slot{
    width:120px;
    height:170px;
    perspective:900px;
    position:relative;
  }

  .card-inner{
    width:100%;
    height:100%;
    border-radius:8px;
    transform-style:preserve-3d;
    transition: transform 0.6s;
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    cursor:pointer;
  }
  .card-inner.flipped{
    transform: rotateY(180deg);
  }
  .card-face{
    position:absolute;
    inset:0;
    backface-visibility:hidden;
    border-radius:8px;
    overflow:hidden;
  }
  .card-back{
    background: linear-gradient(180deg,#2b2b6b,#111133);
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-weight:700;
    transform: rotateY(0deg);
  }
  .card-front{
    transform: rotateY(180deg);
    background:#fff;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:6px;
    box-sizing:border-box;
  }
  .card-front img{
    width:100%;
    height:100%;
    object-fit:cover;
  }

  .stats{
    display:flex;
    gap:12px;
    justify-content:space-between;
    align-items:center;
  }
  .stat{
    background:#f6f9ff;
    padding:8px 10px;
    border-radius:10px;
    color:#0f1b3a;
    font-weight:700;
  }

  .collection{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
  }
  .collection .mini{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .small{
    font-size:13px;
    color:var(--muted);
  }

  .panel-scroll{
    max-height:220px;
    overflow:auto;
    padding-right:6px;
  }

  /* modal */
  .modal{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background: rgba(10,12,20,0.45);
  }
  .modal.show{ display:flex; }
  .modal-card{
    width:760px;
    max-width:94%;
    background:white;
    border-radius:12px;
    padding:18px;
  }
  .modal-card img{ width:160px; height:auto; border-radius:8px; margin-right:12px; }
  .modal-row{ display:flex; gap:12px; align-items:flex-start; }

  footer{ font-size:12px; color:var(--muted); text-align:center; margin-top:6px; }
  @media (max-width:980px){
    .wrap{ grid-template-columns: 1fr; padding-bottom:60px; }
    .pack{ width:260px; height:360px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <div class="pack-stage">
      <div class="pack" id="pack">
        <!-- Put your LOB booster art in the same folder as index.html and name it LOB.jpg -->
        <img src="LOB.jpg" alt="LOB Booster" id="packImg" />
      </div>
      <div class="open-hint">Legend of Blue-Eyes White Dragon — 9 cards per pack</div>

      <div class="controls" style="margin-top:6px;">
        <button class="btn" id="openBtn">Open Pack</button>
        <button class="btn secondary" id="resetCollection">Reset Collection</button>
      </div>

      <div style="margin-top:12px; width:100%;">
        <div class="stats">
          <div class="stat">Packs opened: <span id="packsOpened">0</span></div>
          <div class="stat">Total cards: <span id="totalCards">0</span></div>
          <div class="stat">Unique: <span id="uniqueCards">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="right">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">Pack Reveal</h3>
      <div class="small">Click each card to flip & view. Collection stored on your device.</div>
    </div>

    <div class="reveal-area" id="revealArea">
      <!-- 9 card slots injected here -->
    </div>

    <div style="display:flex; gap:12px; align-items:center;">
      <div style="flex:1">
        <h4 style="margin:0 0 8px 0">Collection Preview</h4>
        <div class="panel-scroll" id="collectionList" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
      </div>
      <div style="width:220px">
        <h4 style="margin:0 0 8px 0">Quick Actions</h4>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <button class="btn" id="openMany">Open 10 Packs</button>
          <button class="btn secondary" id="exportBtn">Export Collection</button>
        </div>
      </div>
    </div>

    <footer>Built with YGOPRODeck API • Legend of Blue-Eyes White Dragon</footer>
  </div>
</div>

<!-- modal for card details -->
<div class="modal" id="modal">
  <div class="modal-card" id="modalCard">
    <div style="display:flex; gap:12px;">
      <img src="" id="modalImg" alt="card" />
      <div>
        <h3 id="modalName">Card Name</h3>
        <div id="modalType" class="small"></div>
        <div style="margin-top:10px;" id="modalText"></div>
        <div style="margin-top:14px;">
          <button class="btn" id="closeModal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/*
  LOB Pack Opener
  - Uses YGOPRODeck API to pull cards for the set "Legend of Blue-Eyes White Dragon"
  - Packs = 9 cards. We emulate "8 commons + 1 rare-ish" by preferring rarities if available,
    but allow duplicates (as real packs sometimes have).
  - Collection saved in localStorage as JSON: { cardName: count, ... }
*/

const API_BASE = "https://db.ygoprodeck.com/api/v7";
const SET_NAME = "Legend of Blue Eyes White Dragon"; // human name used for filtering
const PACK_SIZE = 9;

let setCards = []; // fetched card objects for the set
let collection = {};
let packsOpened = 0;

const revealArea = document.getElementById('revealArea');
const packsOpenedEl = document.getElementById('packsOpened');
const totalCardsEl = document.getElementById('totalCards');
const uniqueCardsEl = document.getElementById('uniqueCards');
const collectionList = document.getElementById('collectionList');
const modal = document.getElementById('modal');
const modalImg = document.getElementById('modalImg');
const modalName = document.getElementById('modalName');
const modalText = document.getElementById('modalText');
const modalType = document.getElementById('modalType');

async function fetchSetCards(){
  // Try the straightforward endpoint first
  try{
    // YGOPRODeck uses "cardinfo.php?cardset=" or cardinfo.php?cardSets= maybe variation
    // We'll attempt a couple of likely query formats gracefully.
    const enc = encodeURIComponent("Legend of Blue-Eyes White Dragon");
    let urls = [
      `${API_BASE}/cardinfo.php?cardset=${enc}`,
      `${API_BASE}/cardinfo.php?cardsetName=${enc}`,
      `${API_BASE}/cardsets.php`
    ];
    // 1st try: cardset
    let resp = await fetch(urls[0]);
    if(resp.ok){
      let json = await resp.json();
      if(Array.isArray(json) && json.length>0){
        setCards = json;
        console.log("Loaded cards via cardset query", setCards.length);
        return;
      }
    }
    // fallback: try to fetch cardsets to get exact set name or code then fetch cardinfo
    resp = await fetch(urls[2]);
    if(resp.ok){
      const allSets = await resp.json();
      // find best match ignoring punctuation & case
      const match = allSets.find(s => s.set_name && s.set_name.toLowerCase().includes("legend of blue"));
      if(match && match.set_name){
        const encName = encodeURIComponent(match.set_name);
        const r2 = await fetch(`${API_BASE}/cardinfo.php?cardset=${encName}`);
        if(r2.ok){
          const j2 = await r2.json();
          if(Array.isArray(j2) && j2.length>0){
            setCards = j2;
            console.log("Loaded cards via resolved set name", setCards.length);
            return;
          }
        }
      }
    }
    // final fallback: fetch all cards of the set by searching term and filter client-side
    // we try a search by name "Legend of Blue" that may return some cards then filter by card_sets property
    const searchResp = await fetch(`${API_BASE}/cardinfo.php?fname=blue`);
    if(searchResp.ok){
      const j3 = await searchResp.json();
      if(Array.isArray(j3)){
        setCards = j3.filter(c => Array.isArray(c.card_sets) && c.card_sets.some(s => String(s.set_name).toLowerCase().includes("legend of blue")));
        console.log("Fallback filtered count:", setCards.length);
        return;
      }
    }
    console.warn("Couldn't fetch set directly; setCards empty.");
  }catch(err){
    console.error("Error fetching set:", err);
  }
}

function saveCollection(){
  localStorage.setItem('lob_collection_v1', JSON.stringify(collection));
  localStorage.setItem('lob_packs_opened_v1', packsOpened);
}

function loadCollection(){
  const raw = localStorage.getItem('lob_collection_v1');
  const pk = localStorage.getItem('lob_packs_opened_v1');
  try{
    collection = raw ? JSON.parse(raw) : {};
    packsOpened = pk ? Number(pk) : 0;
  }catch(e){
    collection = {};
    packsOpened = 0;
  }
  updateStats();
  renderCollectionList();
}

function updateStats(){
  let total = 0;
  let unique = Object.keys(collection).length;
  for(const k in collection) total += collection[k];
  packsOpenedEl.textContent = packsOpened;
  totalCardsEl.textContent = total;
  uniqueCardsEl.textContent = unique;
}

function renderCollectionList(){
  collectionList.innerHTML = "";
  const entries = Object.entries(collection).sort((a,b)=> b[1]-a[1]).slice(0,60);
  for(const [name,count] of entries){
    const div = document.createElement('div');
    div.style.display='flex';
    div.style.alignItems='center';
    div.style.gap='6px';
    div.style.padding='6px 8px';
    div.style.background='#f7f9ff';
    div.style.borderRadius='8px';
    div.style.fontSize='13px';
    div.textContent = `${name} ×${count}`;
    collectionList.appendChild(div);
  }
}

function showModal(card){
  modalImg.src = card.card_images?.[0]?.image_url || '';
  modalName.textContent = card.name || 'Unknown';
  modalType.textContent = `${card.type || ''} ${card.race ? ' — ' + card.race : ''}`;
  modalText.innerHTML = card.desc ? card.desc.replace(/\n/g,'<br>') : '<i>No description</i>';
  modal.classList.add('show');
}

document.getElementById('closeModal').addEventListener('click', ()=> modal.classList.remove('show'));
modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('show'); });

function createFaceDownSlot(index){
  const slot = document.createElement('div');
  slot.className = 'card-slot';
  slot.innerHTML = `
    <div class="card-inner" data-index="${index}">
      <div class="card-face card-back"><div style="text-align:center"><div style="font-size:14px">Click to reveal</div></div></div>
      <div class="card-face card-front"><div class="front-content" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center"></div></div>
    </div>`;
  return slot;
}

function revealCardsUI(cards){
  // populate 9 slots face-down
  revealArea.innerHTML = '';
  for(let i=0;i<PACK_SIZE;i++){
    const slot = createFaceDownSlot(i);
    revealArea.appendChild(slot);
  }

  // attach click behavior (flip)
  const inners = revealArea.querySelectorAll('.card-inner');
  inners.forEach((inner, idx) => {
    inner.addEventListener('click', async function revealOnce(){
      if(inner.classList.contains('flipped')) return;
      inner.classList.add('flipped');
      // fill front with actual card image + attach modal open
      const front = inner.querySelector('.front-content');
      const card = cards[idx];
      if(!card) {
        front.innerHTML = '<div style="font-size:12px;color:#666">No card</div>';
        return;
      }
      // image element
      const img = document.createElement('img');
      img.style.width='100%';
      img.style.height='100%';
      img.style.objectFit='cover';
      img.src = card.card_images?.[0]?.image_url || '';
      front.appendChild(img);

      // update collection
      collection[card.name] = (collection[card.name] || 0) + 1;
      saveCollection();
      updateStats();
      renderCollectionList();

      // on long click or double click open modal
      inner.addEventListener('dblclick', ()=> showModal(card));
      // also open modal if card image clicked
      img.addEventListener('click', (e)=>{ e.stopPropagation(); showModal(card); });
    }, {once:true});
  });
}

function pickPack(){
  // Simple pack logic:
  // - Try to draw 1 card that is "Rare or better" (if set has rarities in card_sets)
  // - The rest are random from set.
  // We'll inspect the card.card_sets array to attempt rarity-aware pick.
  if(!setCards || setCards.length===0) {
    // fallback: create placeholders
    const placeholders = new Array(PACK_SIZE).fill(null).map(_=>({ name: "Unknown", card_images: [{ image_url: '' }], desc: "Offline or API error." }));
    return placeholders;
  }

  // Build pools
  const poolAll = setCards;
  const poolRare = poolAll.filter(c => {
    if(!c.card_sets) return false;
    // card_sets contains set_name and rarity, match the exact LOB set
    return c.card_sets.some(s => String(s.set_name).toLowerCase().includes("legend of blue") && /rare|ultra|super|secret/i.test(String(s.rarity||"")));
  });

  let chosen = [];
  // pick 1 from rare pool (if any)
  if(poolRare.length>0){
    chosen.push(poolRare[Math.floor(Math.random()*poolRare.length)]);
  }else{
    chosen.push(poolAll[Math.floor(Math.random()*poolAll.length)]);
  }
  // pick remaining randomly (allow duplicates)
  for(let i=chosen.length;i<PACK_SIZE;i++){
    chosen.push(poolAll[Math.floor(Math.random()*poolAll.length)]);
  }
  return chosen;
}

/* animation for pack open */
async function doOpenPackAnimation(){
  const packEl = document.getElementById('pack');
  const openBtn = document.getElementById('openBtn');
  openBtn.disabled = true;

  // small press animation
  packEl.animate([{transform:'scale(1)'},{transform:'scale(.98)'}], {duration:120, fill:'forwards'});
  await new Promise(r=>setTimeout(r,150));

  // generate cards (fetching if needed)
  const cards = pickPack();

  // small "ripping" reveal: shrink pack to top and show slots
  packEl.animate([{transform:'translateY(0) scale(1)'},{transform:'translateY(-32px) scale(.9)', opacity:0.9}], {duration:350, fill:'forwards'});
  await new Promise(r=>setTimeout(r,360));

  // show slots
  revealCardsUI(cards);

  // update counters
  packsOpened++;
  saveCollection();
  updateStats();

  // slight staggered animation for slots
  const slots = document.querySelectorAll('.card-slot');
  slots.forEach((s,i)=>{
    s.style.transform='translateY(20px)';
    s.style.opacity='0';
    setTimeout(()=>{ s.style.transition='all .36s cubic-bezier(.2,.8,.2,1)'; s.style.transform='translateY(0)'; s.style.opacity='1'; }, 60*i);
  });

  openBtn.disabled = false;
}

document.getElementById('openBtn').addEventListener('click', async ()=>{
  await ensureSetLoaded();
  doOpenPackAnimation();
});
document.getElementById('pack').addEventListener('click', async ()=>{
  await ensureSetLoaded();
  doOpenPackAnimation();
});

document.getElementById('openMany').addEventListener('click', async ()=>{
  await ensureSetLoaded();
  // open 10 packs in quick succession
  for(let i=0;i<10;i++){
    doOpenPackAnimation();
    await new Promise(r=>setTimeout(r,700));
  }
});

document.getElementById('resetCollection').addEventListener('click', ()=>{
  if(!confirm('Reset your local collection? This cannot be undone.')) return;
  collection = {};
  packsOpened = 0;
  saveCollection();
  updateStats();
  renderCollectionList();
  revealArea.innerHTML = '';
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const exportObj = { packsOpened, collection, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(exportObj, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'lob_collection.json';
  a.click();
  URL.revokeObjectURL(url);
});

/* ensure setCards loaded once */
let _loading = false;
async function ensureSetLoaded(){
  if(setCards && setCards.length>0) return;
  if(_loading) {
    // wait until loaded
    while(_loading) await new Promise(r=>setTimeout(r,200));
    return;
  }
  _loading = true;
  // fetch carefully
  try{
    await fetchSetCards();
    if(setCards.length===0){
      // try one more graceful attempt: fetch pack page then fallback to general query for "Blue-Eyes"
      const r = await fetch(`${API_BASE}/cardinfo.php?fname=Blue-Eyes`);
      if(r.ok){
        const j = await r.json();
        if(Array.isArray(j) && j.length>0){
          setCards = j;
        }
      }
    }
  }catch(e){ console.error(e); }
  _loading = false;
}

/* init */
loadCollection();
ensureSetLoaded();

</script>
</body>
</html>
